# ğŸ’° PAYMENT SYSTEM - VISUAL ARCHITECTURE

## System Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER JOURNEY                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Takes Test
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ canStartTest(userId) â†’ Check Entitlement                        â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ Is subscription active?                  â”‚                   â”‚
â”‚  â”‚ (status='active' AND expiryDate > now)  â”‚                   â”‚
â”‚  â”‚         NO â†“                            â”‚                   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                   â”‚
â”‚  â”‚ â”‚ free_tests_used < 5?     â”‚            â”‚                   â”‚
â”‚  â”‚ â”‚   YES â†’ ALLOW & INCREMENT â”‚            â”‚                   â”‚
â”‚  â”‚ â”‚   NO  â†’ BLOCK (402)       â”‚            â”‚                   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚         YES â†’ ALLOW UNLIMITED              â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Database Schema Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       USER (Updated)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ _id                      â”‚
â”‚ email                    â”‚
â”‚ password                 â”‚
â”‚ handle                   â”‚
â”‚ â—free_tests_used (0-5)   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ name                     â”‚         â”‚
â”‚ role                     â”‚         â”‚
â”‚ ...                      â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                                      â”‚ references
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  SUBSCRIPTION (NEW)          â”‚      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚ _id                          â”‚      â”‚
â”‚ userId (unique, indexed) â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜
â”‚ status (active/expired)      â”‚
â”‚ plan (monthly/6m/yearly)     â”‚
â”‚ startDate                    â”‚
â”‚ expiryDate (indexed) â—„â”€â”€â”€â”   â”‚
â”‚ lastPaymentId â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚ createdAt           â”‚    â”‚   â”‚
â”‚ updatedAt           â”‚    â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”˜
                       â”‚    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
        â”‚                   â”‚
        â†“                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  PAYMENT (Updated)   â”‚    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚ _id                  â”‚    â”‚
â”‚ userId (indexed)     â”‚    â”‚
â”‚ amount               â”‚    â”‚
â”‚ currency             â”‚    â”‚
â”‚ â—plan (NEW)          â”‚    â”‚
â”‚ status               â”‚    â”‚
â”‚ razorpayOrderId      â”‚    â”‚
â”‚ razorpayPaymentId    â”‚    â”‚
â”‚ razorpaySignature    â”‚    â”‚
â”‚ email                â”‚    â”‚
â”‚ failureReason        â”‚    â”‚
â”‚ createdAt (indexed)  â”‚    â”‚
â”‚ completedAt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”˜
â”‚ updatedAt            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Payment Flow (Sequence Diagram)

```
USER              FRONTEND            BACKEND           RAZORPAY
  â”‚                 â”‚                   â”‚                 â”‚
  â”‚ Click Subscribe â”‚                   â”‚                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                   â”‚                 â”‚
  â”‚                 â”‚ POST /create-orderâ”‚                 â”‚
  â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
  â”‚                 â”‚ { plan: "monthly" }â”‚                 â”‚
  â”‚                 â”‚                   â”‚ Create Order    â”‚
  â”‚                 â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                 â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                 â”‚                   â”‚ orderId, amount â”‚
  â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
  â”‚                 â”‚ { orderId }       â”‚                 â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                 â”‚
  â”‚ Show Checkout   â”‚                   â”‚                 â”‚
  â”‚ (Razorpay Modal)â”‚                   â”‚                 â”‚
  â”‚                 â”‚                   â”‚                 â”‚
  â”‚ User Pays       â”‚                   â”‚                 â”‚
  â”‚ (Test Card)     â”‚                   â”‚                 â”‚
  â”‚                 â”‚ Verify Signature  â”‚                 â”‚
  â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
  â”‚                 â”‚ POST /verify-payment                â”‚
  â”‚                 â”‚ {orderId, payId,  â”‚                 â”‚
  â”‚                 â”‚  signature}       â”‚                 â”‚
  â”‚                 â”‚                   â”‚ Double Check    â”‚
  â”‚                 â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                 â”‚                   â”‚ Fetch Payment   â”‚
  â”‚                 â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                 â”‚                   â”‚ Verified âœ“      â”‚
  â”‚                 â”‚                   â”‚                 â”‚
  â”‚                 â”‚                   â”‚ Create/Extend   â”‚
  â”‚                 â”‚                   â”‚ Subscription    â”‚
  â”‚                 â”‚                   â”‚ (expiryDate)    â”‚
  â”‚                 â”‚                   â”‚                 â”‚
  â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
  â”‚                 â”‚ Success âœ“         â”‚                 â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                 â”‚
  â”‚ Unlimited Tests â”‚                   â”‚                 â”‚
  â”‚ Active âœ“        â”‚                   â”‚                 â”‚
  
```

## Entitlement Logic Flow

```
User Attempts Test
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Query Subscription Collection      â”‚
â”‚  WHERE userId = X AND               â”‚
â”‚        status = 'active' AND         â”‚
â”‚        expiryDate > NOW              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
   YES      NO
    â”‚        â”‚
    â†“        â†“
  â”Œâ”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚âœ…   â”‚   â”‚ Query User.free_tests_usedâ”‚
  â”‚ALLOWâ”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚     â”‚           â”‚
  â”‚UNLIMâ”‚       â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”
  â”‚TESTSâ”‚      < 5       â‰¥ 5
  â””â”€â”€â”€â”€â”€â”˜       â”‚         â”‚
                â†“         â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚âœ… ALLOW â”‚  â”‚âŒ BLOCKEDâ”‚
            â”‚+ INCR   â”‚  â”‚(402)     â”‚
            â”‚COUNTER  â”‚  â”‚SHOW PAY  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Subscription Extension Logic

```
User Has Subscription
  (Expires: Jan 2, 2025)
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Buys 6-Month Plan (â‚¹1499)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Verify Payment Success             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Check: Existing Active Subscription?â”‚
â”‚  (Now < ExpiryDate)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
   YES      NO
    â”‚        â”‚
    â†“        â†“
  EXTEND   CREATE NEW
    â”‚        â”‚
    â”‚        â†“
    â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     â”‚ expiryDate = NOW     â”‚
    â”‚     â”‚ + 180 days           â”‚
    â”‚     â”‚ = July 3, 2025       â”‚
    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ expiryDate =         â”‚
  â”‚ Jan 2, 2025          â”‚
  â”‚ + 180 days           â”‚
  â”‚ = July 3, 2025       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## API Endpoint Architecture

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   /api/payments (Protected)     â”‚
                    â”‚   (Requires JWT Token)          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚             â”‚             â”‚
                    â†“             â†“             â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ POST             â”‚  â”‚ GET /subscription  â”‚
          â”‚ /create-order    â”‚  â”‚ /free-tests        â”‚
          â”‚                  â”‚  â”‚ /history           â”‚
          â”‚ Body:            â”‚  â”‚                    â”‚
          â”‚ { plan }         â”‚  â”‚ Returns:           â”‚
          â”‚                  â”‚  â”‚ Status info        â”‚
          â”‚ Returns:         â”‚  â”‚ Usage stats        â”‚
          â”‚ orderId, amount  â”‚  â”‚ Payment history    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ POST              â”‚
          â”‚ /verify-payment  â”‚
          â”‚                  â”‚
          â”‚ Body:            â”‚
          â”‚ { razorpayOrderIdâ”‚
          â”‚   razorpayPaymentId
          â”‚   razorpaySignature
          â”‚                  â”‚
          â”‚ Returns:         â”‚
          â”‚ payment +        â”‚
          â”‚ subscription     â”‚
          â”‚ (if extended)    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Frontend Component Tree

```
App
â”œâ”€â”€ PaymentComponent
â”‚   â”œâ”€â”€ Subscription Status Display
â”‚   â”‚   â”œâ”€â”€ Plan Name
â”‚   â”‚   â”œâ”€â”€ Status Badge (Active/Expired)
â”‚   â”‚   â””â”€â”€ Days Remaining
â”‚   â”‚
â”‚   â”œâ”€â”€ Free Tests Display
â”‚   â”‚   â”œâ”€â”€ Used Count
â”‚   â”‚   â”œâ”€â”€ Remaining Count
â”‚   â”‚   â””â”€â”€ Progress Bar
â”‚   â”‚
â”‚   â”œâ”€â”€ Plan Selector (3 Cards)
â”‚   â”‚   â”œâ”€â”€ Monthly Card (â‚¹299)
â”‚   â”‚   â”œâ”€â”€ 6 Months Card (â‚¹1499)
â”‚   â”‚   â””â”€â”€ Yearly Card (â‚¹2499)
â”‚   â”‚
â”‚   â”œâ”€â”€ Subscribe Button
â”‚   â”‚   â””â”€â”€ onClick â†’ processSubscriptionPayment()
â”‚   â”‚
â”‚   â””â”€â”€ Message Display
â”‚       â”œâ”€â”€ Success Message
â”‚       â””â”€â”€ Error Message
â”‚
â””â”€â”€ TestComponent
    â”œâ”€â”€ Check Entitlement (getTest)
    â”‚   â”œâ”€â”€ canStartTest() â†’ true/false
    â”‚   â””â”€â”€ If false â†’ Show PaymentComponent
    â”‚
    â””â”€â”€ Test Interface
        â””â”€â”€ Only if entitled
```

## Data Flow: Test Taking

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Clicks "Start Test"                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend: GET /api/tests/{testId}                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend (testController.getTest):                       â”‚
â”‚ âœ“ Verify user authorized                               â”‚
â”‚ âœ“ Check test published                                 â”‚
â”‚ âœ“ Check test not expired                               â”‚
â”‚ NEW: âœ“ Check entitlement                               â”‚
â”‚      â””â”€> Call canStartTest(userId)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ canStartTest Logic:                                      â”‚
â”‚                                                         â”‚
â”‚ 1. Check Subscription.findOne({                        â”‚
â”‚      userId, status='active', expiryDate>now           â”‚
â”‚    })                                                   â”‚
â”‚                                                         â”‚
â”‚    IF YES â†’ return {canStart: true}                    â”‚
â”‚                                                         â”‚
â”‚ 2. Check User.free_tests_used < 5                      â”‚
â”‚                                                         â”‚
â”‚    IF YES â†’ return {canStart: true, reason: 'free'} â”‚
â”‚                                                         â”‚
â”‚ 3. Otherwise:                                          â”‚
â”‚    return {canStart: false, reason: 'no_entitlement'}â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
     YES              NO
      â”‚                â”‚
      â†“                â†“
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚Return  â”‚    â”‚Return 402    â”‚
 â”‚Test    â”‚    â”‚Payment       â”‚
 â”‚Content â”‚    â”‚Required      â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                â”‚
      â†“                â†“
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚Show    â”‚    â”‚Show         â”‚
 â”‚Test    â”‚    â”‚Subscribe    â”‚
 â”‚Page    â”‚    â”‚Button       â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Security Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Submits Payment          â”‚
â”‚ (Razorpay Checkout)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Frontend Receives:          â”‚
        â”‚ - razorpayOrderId           â”‚
        â”‚ - razorpayPaymentId         â”‚
        â”‚ - razorpaySignature         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ POST /verify-payment        â”‚
        â”‚ (Backend: paymentController)â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                           â”‚
      â†“                           â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Verify HMAC  â”‚        â”‚Find Payment  â”‚
   â”‚ Signature:   â”‚        â”‚Record in DB  â”‚
   â”‚              â”‚        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ Expected =   â”‚               â”‚
   â”‚ HMAC-SHA256( â”‚               â†“
   â”‚   orderId|   â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   paymentId, â”‚        â”‚Double-verify     â”‚
   â”‚   SECRET)    â”‚        â”‚with Razorpay API:â”‚
   â”‚              â”‚        â”‚                  â”‚
   â”‚ vs           â”‚        â”‚payments.fetch()  â”‚
   â”‚              â”‚        â”‚status='captured' â”‚
   â”‚ Received     â”‚        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ Signature    â”‚               â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
          â”‚                       â”‚
     â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    YES           NO        YES          NO
     â”‚             â”‚         â”‚            â”‚
     â†“             â†“         â†“            â†“
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚Proceed â”‚   â”‚REJECT  â”‚ â”‚Proceed â”‚  â”‚REJECT  â”‚
 â”‚âœ“       â”‚   â”‚âŒ      â”‚ â”‚âœ“       â”‚  â”‚âŒ      â”‚
 â”‚        â”‚   â”‚Sig     â”‚ â”‚        â”‚  â”‚Payment â”‚
 â”‚        â”‚   â”‚Invalid â”‚ â”‚        â”‚  â”‚Failed  â”‚
 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                        â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Update Payment DB  â”‚
        â”‚ status = 'success' â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚Create/Extend       â”‚
        â”‚Subscription        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚Return Success âœ“    â”‚
        â”‚(payment + sub)     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Test Status Logic

```
User                 User              User
(Free)               (Free Used)        (Paid)

free_tests_used=0    free_tests_used=5  subscription
subscription=None    subscription=None  expiryDate>now
                                        
Tests 1-5: âœ…        Tests 1-5: âœ…      All Tests: âœ…
Test 6: âŒ           Test 6: âŒ         Unlimited: âœ…
        
Blocked              Blocked            Active
(show payment)       (show payment)      (no payment)
```

---

This visual summary shows how all the payment components work together!
